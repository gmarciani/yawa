version: "3.9"

services:
  #frontend:
  #  container_name: frontend
  #  build:
  #    context: frontend
  #  ports:
  #    - 3000:3000
  #  env_file: frontend/docker.env
  #  restart: always
  #  stdin_open: true #https://github.com/docker/compose/issues/5016
  #  depends_on:
  #    - database
  #    - server

  server:
    container_name: server
    build:
      context: server
    ports:
      - "8002:8000"
      - "8006:8001"
    env_file: server/docker.env
    restart: always
    volumes:
      - ./server:/usr/src/yawa
      - ./server/.container/var/yawa/logs:/var/yawa/logs
    depends_on:
      - database

  database:
    container_name: database
    build:
      context: database
    env_file: database/docker.env
    ports:
      - "3307:3306"
    restart: always
    volumes:
      - dbdata:/var/lib/mysql

  dbadmin:
    container_name: dbadmin
    image: phpmyadmin
    restart: always
    ports:
      - "8003:80"
    environment:
      - PMA_ARBITRARY=1
    depends_on:
      - database

  prometheus:
    container_name: prometheus
    build:
      context: prometheus
    env_file: prometheus/docker.env
    restart: always
    ports:
      - "8004:9090"
    volumes:
      - ./prometheus/config/prometheus.yaml:/etc/prometheus/prometheus.yml
    depends_on:
      - server

  grafana:
    container_name: grafana
    build:
      context: grafana
    restart: always
    ports:
      - "8005:3000"
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus

volumes:
  dbdata: